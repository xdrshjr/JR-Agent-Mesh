# JRAgentMesh — Master Plan

## 1. 项目概述与目标

JRAgentMesh 是一个基于 Web 的 AI Agent 管理平台，可部署在本地服务器上，用户通过浏览器从任何设备访问。平台具备双重能力：

- **自身 Agent 能力**：基于 pi-mono（`@mariozechner/pi-agent-core` + `@mariozechner/pi-ai`）构建，具备完整的通用 Agent 能力（对话、代码生成、文件操作、命令执行等）
- **多 Agent 管理能力**：可拉起、管理、监控多个后台 Coding Agent 进程（Claude Code、OpenCode、Codex），并在前端实时查看执行状态

设计风格参照 Figma，追求简约、优雅、专业的浅色主题界面。

### 核心目标

| 目标 | 描述 |
|------|------|
| 随时随地访问 | 部署后通过浏览器访问，无需安装客户端 |
| 自身智能 | 内置通用 Agent，可直接对话、写代码、操作文件 |
| 多 Agent 管理 | 同时管理多个后台 Coding Agent，标签页切换 |
| 任务调度 | 自身 Agent 可作为调度者分发任务给后台 Agent（开关控制） |
| 持久运行 | Agent 进程独立于浏览器会话，断开重连可恢复 |
| 零门槛 | 无需账号密码登录 |

## 2. 范围定义

### 在范围内（In Scope）

- 自身 Agent 对话界面（基于 pi-mono）
- 后台 Agent 进程管理（启动/停止/监控）
- 执行状态 Timeline（中级别：工具调用序列）
- 对话内文件双向传输
- API 凭证管理（服务端存储，前端编辑）
- 多 LLM 提供商支持 + 自定义 URL/API Key
- SQLite 持久化（对话历史、Agent 记录、设置）
- 浅色主题 Figma 风格 UI
- 声音通知（可开关）
- 移动端访问提醒（不支持移动端）

### 不在范围内（Out of Scope）

- 云部署与多租户
- 用户认证系统（账号/密码/OAuth）
- 移动端响应式适配
- 复杂的 Agent 编排（DAG、流水线、依赖链）
- Agent 自动安装（假设 CLI 已预装在服务器上）
- 深色主题（v1 不包含）

## 3. 高层架构

```
┌─────────────────────────────────────────────────────────┐
│                    Browser (Client)                      │
│  ┌───────────────────────────────────────────────────┐  │
│  │              Next.js Frontend (React)              │  │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────────────┐  │  │
│  │  │ 自身Agent │ │ Agent标签 │ │   设置页面       │  │  │
│  │  │ 对话界面  │ │ 管理面板  │ │  凭证/通知/通用  │  │  │
│  │  └──────────┘ └──────────┘ └──────────────────┘  │  │
│  └───────────────────┬───────────────────────────────┘  │
│                      │ WebSocket + HTTP                  │
└──────────────────────┼──────────────────────────────────┘
                       │
┌──────────────────────┼──────────────────────────────────┐
│                 Server (Node.js)                         │
│  ┌───────────────────┴───────────────────────────────┐  │
│  │            Custom Server (Express/ws)              │  │
│  │  ┌────────────┐  ┌─────────────┐  ┌───────────┐  │  │
│  │  │ WebSocket  │  │  REST API   │  │  Static   │  │  │
│  │  │  Handler   │  │  Routes     │  │  Next.js  │  │  │
│  │  └─────┬──────┘  └──────┬──────┘  └───────────┘  │  │
│  └────────┼────────────────┼─────────────────────────┘  │
│           │                │                             │
│  ┌────────┴────────────────┴─────────────────────────┐  │
│  │              Core Services Layer                   │  │
│  │  ┌──────────────┐  ┌──────────────────────────┐   │  │
│  │  │  Self-Agent   │  │  Agent Process Manager   │   │  │
│  │  │  (pi-mono)    │  │  (子进程生命周期管理)     │   │  │
│  │  └──────────────┘  └──────────────────────────┘   │  │
│  │  ┌──────────────┐  ┌──────────────────────────┐   │  │
│  │  │  Session      │  │  File Transfer           │   │  │
│  │  │  Manager      │  │  Service                 │   │  │
│  │  └──────────────┘  └──────────────────────────┘   │  │
│  │  ┌──────────────────────────────────────────────┐ │  │
│  │  │  SQLite Database (Drizzle ORM)               │ │  │
│  │  │  对话历史 | Agent记录 | 凭证 | 设置          │ │  │
│  │  └──────────────────────────────────────────────┘ │  │
│  └───────────────────────────────────────────────────┘  │
│                                                          │
│  ┌───────────────────────────────────────────────────┐  │
│  │           Backend Agent Processes                  │  │
│  │  ┌─────────┐  ┌──────────┐  ┌─────────────────┐  │  │
│  │  │ Claude  │  │ OpenCode │  │     Codex       │  │  │
│  │  │ Code    │  │          │  │                 │  │  │
│  │  │ (CLI)   │  │ (CLI)    │  │ (CLI)           │  │  │
│  │  └─────────┘  └──────────┘  └─────────────────┘  │  │
│  └───────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────┘
```

### 技术栈

| 层级 | 技术选型 | 理由 |
|------|---------|------|
| 前端框架 | Next.js 15 (App Router) | SSR + 文件路由，React 生态成熟 |
| UI 组件库 | shadcn/ui + Tailwind CSS v4 | Figma 风格简约设计，高度可定制 |
| 状态管理 | Zustand | 轻量、简单、适合中等复杂度 |
| 实时通信 | 原生 WebSocket (ws) | 低延迟双向通信，无需 Socket.io 的额外开销 |
| 服务端框架 | Express.js (自定义服务器) | 托管 Next.js + WebSocket，灵活控制 |
| 自身 Agent | @mariozechner/pi-agent-core + pi-ai | pi-mono 的核心能力包 |
| ORM | Drizzle ORM | 轻量、TypeScript 原生、SQLite 支持好 |
| 数据库 | SQLite (better-sqlite3) | 本地部署，零配置，文件级数据库 |
| 进程管理 | Node.js child_process | 管理后台 Agent CLI 进程 |
| 语言 | TypeScript (全栈) | 类型安全，前后端统一 |

## 4. 关键设计决策

### 4.1 自定义服务器而非纯 Next.js

**决策**：使用 Express.js 作为自定义服务器，内嵌 Next.js 处理页面渲染。

**理由**：Next.js API Routes 是无状态的 serverless 函数，无法：
- 维持 WebSocket 长连接
- 管理长生命周期的 Agent 进程
- 保持内存中的会话状态

自定义服务器可以同时托管 WebSocket、REST API 和 Next.js 页面。

### 4.2 后台 Agent 通过 PTY 伪终端管理

**决策**：使用 `node-pty` 创建伪终端来运行后台 Agent CLI 进程。

**理由**：
- 后台 Agent（Claude Code、OpenCode、Codex）都是交互式 CLI 工具
- PTY 可以正确处理 ANSI 转义码、颜色输出
- 可以向进程发送输入（模拟用户在终端输入）
- 比普通 child_process.spawn 更好地模拟终端行为

### 4.3 WebSocket 消息协议

**决策**：设计统一的 JSON 消息协议，所有前后端通信走 WebSocket。

**理由**：
- 自身 Agent 的流式输出需要实时推送
- 后台 Agent 的状态变更需要实时通知
- 文件传输进度需要实时反馈
- 统一协议降低复杂度

### 4.4 自身 Agent 的传输层适配

**决策**：利用 pi-agent-core 的 `streamFn` 抽象，将 WebSocket 作为传输层。

**理由**：
- pi-mono 的 Agent 类设计为传输无关
- 通过自定义 `streamFn`，将 LLM 调用放在服务端执行
- 前端仅负责展示，所有 Agent 逻辑在服务端运行
- 凭证安全地保存在服务端

### 4.5 后台 Agent 类型注册机制

**决策**：使用 Agent 类型注册表模式，每种 Agent 类型定义为一个配置对象。

**理由**：
- 当前支持 3 种（Claude Code、OpenCode、Codex）
- 需要预留扩展口，未来添加新类型只需注册新配置
- 配置包括：CLI 命令、参数模板、输出解析器、环境变量映射

## 5. 依赖与假设

### 依赖

- Node.js >= 20 已安装在服务器上
- 后台 Agent 的 CLI 工具（claude、opencode、codex）已预装
- 用户拥有对应的 API Key（Anthropic、OpenAI 等）
- pi-mono 包可通过 npm 安装

### 假设

- 单用户使用场景（本地部署，无多租户需求）
- 服务器有足够资源同时运行多个 Agent 进程
- 网络环境允许 WebSocket 长连接（非受限企业防火墙）

## 6. 风险评估

| 风险 | 等级 | 缓解策略 |
|------|------|---------|
| pi-mono API 不稳定 / 版本更新 | 中 | 锁定版本，封装适配层 |
| 后台 Agent CLI 输出格式不统一 | 高 | 每种 Agent 类型实现独立的输出解析器 |
| PTY 在 Windows 上的兼容性 | 中 | 使用 node-pty（跨平台），测试 Windows 环境 |
| WebSocket 断线重连 | 低 | 实现自动重连 + 状态恢复机制 |
| SQLite 并发写入限制 | 低 | 单用户场景，WAL 模式足够 |
| 凭证安全（无登录保护） | 中 | 提示用户仅在可信网络使用，凭证加密存储 |

## 7. Spec 文档目录

| 编号 | 文件名 | 内容 |
|------|--------|------|
| 01 | system-architecture.md | 系统架构详细设计、项目结构、启动流程 |
| 02 | frontend-ui.md | 前端界面设计、页面布局、组件树、交互流程 |
| 03 | self-agent.md | 自身 Agent 集成（pi-mono）、对话流程、工具系统 |
| 04 | backend-agent-manager.md | 后台 Agent 进程管理、类型注册、生命周期 |
| 05 | realtime-communication.md | WebSocket 协议设计、消息类型、断线重连 |
| 06 | data-persistence.md | SQLite Schema 设计、Drizzle ORM 配置 |
| 07 | settings-and-credentials.md | 设置系统、凭证管理、通知配置 |
| 08 | file-transfer.md | 对话内文件传输、上传下载流程 |
