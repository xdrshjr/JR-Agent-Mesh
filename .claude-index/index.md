# Project Index: JRAgentMesh

> Auto-generated by project-indexer | Last updated: 2026-02-14

## Project Overview

- **Type:** Fullstack
- **Languages:** TypeScript (100%)
- **Frameworks:** Next.js 15, Express 4, WebSocket (ws), Drizzle ORM, pi-agent-core
- **Entry Points:** `server/index.ts` (backend), `src/app/page.tsx` (frontend)
- **Database:** SQLite at `./data/jragentmesh.db`

## Feature Map

### Server Bootstrap (`server/`)
Entry: `server/index.ts`
- Application bootstrap: loads env, initializes DB, services, Express, Next.js, WebSocket server, cleanup jobs, graceful shutdown.
- **Key exports:**
  - `main(): Promise<void>` - Startup orchestration
  - `ensureEncryptionKey(): void` - Auto-generates encryption key to .env

### REST API (`server/express-app.ts`)
Entry: `server/express-app.ts`
- Express app with all REST endpoints for conversations, settings, credentials, agents, files, import/export.
- **Key exports:**
  - `createExpressApp(options: ExpressAppOptions): Express.Application`
- **Endpoints:** `/api/health`, `/api/agent-types`, `/api/agents`, `/api/conversations`, `/api/settings`, `/api/credentials`, `/api/providers/:provider/models`, `/api/upload`, `/api/download/:fileId`, `/api/export`, `/api/import`

### WebSocket Layer (`server/websocket/`)
Entry: `server/websocket/server.ts`
- Real-time bidirectional communication with heartbeat, backpressure, and message fragmentation.
- **Key exports:**
  - `initWebSocketServer(httpServer): WebSocketServer` - Initialize WS on `/ws`
  - `sendToClient<T>(ws, type, payload, requestId?): boolean` - Send with auto-fragmentation
  - `broadcastToAllClients<T>(type, payload, requestId?): number` - Broadcast to all clients
  - `registerHandler(type, handler): void` - Register message handler (`handler.ts`)
  - `handleMessage(ws, raw): void` - Route incoming messages (`handler.ts`)
  - `createMessageWithFragmentation<T>(type, payload, requestId?): string[]` - Fragment >64KB messages (`protocol.ts`)
  - `registerChatHandlers(selfAgent): void` - Chat message handlers (`chat-handlers.ts`)
  - `registerAgentHandlers(agentProcessManager): void` - Agent message handlers (`agent-handlers.ts`)

### Self-Agent Service (`server/services/self-agent.ts`)
Entry: `server/services/self-agent.ts`
- Built-in AI assistant using pi-agent-core with tool execution, conversation management, streaming.
- **Key exports:**
  - `SelfAgentService` class
    - `handleUserMessage(conversationId, content, attachments?): Promise<void>` - Process user message
    - `handleAbort(conversationId): void` - Abort generation
    - `handleSteer(conversationId, content): void` - Mid-generation steering
    - `switchModel(provider, modelId): void` - Switch LLM model
    - `createConversation(): Promise<string>` - New conversation
    - `loadConversation(conversationId): Promise<void>` - Load from DB
    - `toggleDispatch(enabled): void` - Enable/disable agent dispatch mode
    - `clearConversation(conversationId): Promise<void>` - Clear conversation messages
    - `setThinkingLevel(level): void` - Set thinking budget level (none/low/medium/high)

### Agent Process Manager (`server/services/agent-process-manager.ts`)
Entry: `server/services/agent-process-manager.ts`
- Spawns and manages CLI agent subprocesses via node-pty with output parsing and WebSocket broadcasting.
- **Key exports:**
  - `AgentProcessManager` class
    - `createProcess(typeId, name?, workDir?, initialPrompt?): Promise<AgentInfo>` - Spawn agent
    - `stopProcess(agentId): Promise<void>` - Graceful stop + force kill
    - `restartProcess(agentId): Promise<AgentInfo>` - Restart with same config
    - `deleteProcess(agentId): Promise<void>` - Remove from memory and DB
    - `sendInput(agentId, text): void` - Send stdin
    - `sendRawInput(agentId, data): void` - Send raw keystrokes (xterm.js)
    - `resizePty(agentId, cols, rows): void` - Resize PTY
    - `listAll(): AgentInfo[]` - List all agents
    - `findOrCreate(typeId, workDir?): Promise<AgentInfo>` - Find or spawn agent
    - `recoverAgents(): void` - Mark stale RUNNING as STOPPED at startup

### Agent Registry (`server/services/agent-registry.ts`)
Entry: `server/services/agent-registry.ts`
- Pluggable registry for CLI agent types (claude-code, opencode, codex).
- **Key exports:**
  - `initAgentRegistry(): void` - Register built-in types
  - `registerAgentType(config: AgentTypeConfig): void`
  - `getAgentType(id): AgentTypeConfig | undefined`
  - `getAllAgentTypes(): AgentTypeConfig[]`
  - `AgentTypeConfig` interface - { id, displayName, command, args, envMapping, inputMode, healthCheck?, icon, description }

### File Transfer (`server/services/file-transfer.ts`)
Entry: `server/services/file-transfer.ts`
- File upload/download with temporary tokens and WebSocket notifications.
- **Key exports:**
  - `FileTransferService` class
    - `prepareDownload(options): { fileId, filename, size, downloadUrl } | { error }`
    - `getUploadInfo(fileId): FileTransfer | null`

### Built-in Tools (`server/services/tools/`)
Entry: `server/services/tools/builtin-tools.ts`
- Tools available to the self-agent: read, write, edit, bash, file_transfer, agent_dispatch.
- **Key exports (builtin-tools.ts):**
  - `readTool` - Read file with optional offset/limit (line-numbered output)
  - `writeTool` - Write file (auto-creates parent dirs)
  - `editTool` - Replace exact string in file
  - `bashTool` - Execute shell command (120s timeout, 100KB output limit)
- **Key exports (custom-tools.ts):**
  - `createFileTransferTool(fileTransferService, getContext): AgentTool` - File download tool
  - `createAgentDispatchTool(agentProcessManager): AgentTool` - Agent task dispatch tool

### Output Parsing (`server/services/output-parsers.ts`)
Entry: `server/services/output-parsers.ts`
- Parse raw agent CLI output into structured events.
- **Key exports:**
  - `RingBuffer` class - Circular char buffer (default 100K chars)
  - `ClaudeCodeParser` class - Parses Claude Code CLI output (tool_start/end for read/write/bash/edit)
  - `GenericCLIParser` class - Pass-through parser returning raw output

### Model Detection (`server/services/model-detection.ts`)
Entry: `server/services/model-detection.ts`
- Auto-detect available models from LLM providers via API.
- **Key exports:**
  - `detectProviderModels(provider, apiKey, overrideUrl?): Promise<DetectionResult>` - Multi-provider model discovery
  - Supports: Anthropic, OpenAI-compatible, Google Generative AI

### Credential Store (`server/services/credential-store.ts`)
Entry: `server/services/credential-store.ts`
- AES-256-GCM encryption wrapper for credential storage.
- **Key exports:**
  - `CredentialStore` class - `encrypt(value): EncryptedData`, `decrypt(data): string`

### Database Layer (`server/db/`)
Entry: `server/db/index.ts`
- SQLite via better-sqlite3 + Drizzle ORM. WAL mode, foreign keys enabled.
- **Key exports (index.ts):**
  - `initDatabase(dbPath): DrizzleDB` - Initialize with auto-migration and seeding
  - `getDb(): DrizzleDB` - Get DB instance
  - `closeDatabase(): void`
- **Schema tables (schema.ts):** `conversations`, `messages`, `agentProcesses`, `agentOutputs`, `credentials`, `settings`, `fileTransfers`
- **Cleanup (cleanup.ts):** `startCleanupJob()`, `stopCleanupJob()` - Hourly: expired files, old outputs (30d), VACUUM

### Repositories (`server/db/repositories/`)
Entry: `server/db/repositories/index.ts`
- Data access layer with repository pattern.
- **Classes:** `ConversationRepository`, `MessageRepository`, `AgentProcessRepository`, `AgentOutputRepository`, `SettingsRepository`, `CredentialRepository`, `FileTransferRepository`

### Crypto Utilities (`server/utils/crypto.ts`)
Entry: `server/utils/crypto.ts`
- AES-256-GCM encryption for credentials.
- **Key exports:**
  - `generateEncryptionKey(): string` - Random 32-byte hex key
  - `encrypt(plaintext, keyHex): EncryptedData`
  - `decrypt(data, keyHex): string`

### Logger (`server/utils/logger.ts`)
Entry: `server/utils/logger.ts`
- Colored console logger with level filtering.
- **Key exports:**
  - `logger` object - `.debug()`, `.info()`, `.warn()`, `.error()`, `.setLevel()`

### Shared Types (`shared/types.ts`)
Entry: `shared/types.ts`
- Protocol contract between server and client. All WebSocket message types and payload interfaces.
- **Key types:** `AgentTypeId`, `AgentStatus`, `AgentInfo`, `ParsedOutput`, `Message`, `Conversation`, `WebSocketMessage`, `ClientMessageType`, `ServerMessageType`, plus all payload interfaces for each message type.

---

### Frontend State (`src/stores/`)
Entry: `src/stores/chat-store.ts`
- Zustand stores for application state.
- **chat-store.ts:** Conversations, messages, streaming state, model selection, dispatch mode, file attachments, thinking level
  - Key actions: `startStreaming()`, `appendStreamDelta()`, `appendThinkingDelta()`, `addToolCallStart()`, `updateToolCallEnd()`, `completeStreaming()`, `clearMessages()`, `setThinkingLevel()`
- **agent-store.ts:** Agent list, selected agent, outputs per agent, tab order, status filter
  - Key actions: `addAgent()`, `removeAgent()`, `updateAgentStatus()`, `appendOutput()`, `setOutputHistory()`
- **settings-store.ts:** Provider/model defaults, credentials, detected models, notification prefs, data retention
  - Key actions: `fetchSettings()`, `saveSettings()`, `fetchCredentials()`, `saveCredential()`, `detectModels()`

### Frontend Hooks (`src/hooks/`)
Entry: `src/hooks/use-websocket.tsx`
- React hooks for WebSocket, agent management, and chat.
- **use-websocket.tsx:**
  - `WebSocketProvider({ children })` - Context provider with event listeners dispatching to stores
  - `useWebSocketClient(): { client, connected }` - Access WS client
  - `useWSEvent<T>(type, callback)` - Subscribe to specific message types
- **use-agent-manager.ts:**
  - `useAgentManager()` - Returns `{ agents, selectedAgentId, createAgent, sendInput, stopAgent, restartAgent, deleteAgent, getOutput }`
- **use-self-agent.ts:**
  - `useSelfAgent()` - Returns `{ provider, model, dispatchMode, isLoading, thinkingLevel, sendMessage, switchModel, toggleDispatch, abort, newConversation, loadConversation, clearConversation, setThinkingLevel }`
- **use-keyboard-shortcuts.ts:**
  - `useKeyboardShortcuts()` - Ctrl+1/2/3 navigation, Ctrl+N new conversation, Ctrl+K command palette, Escape close modals

### WebSocket Client (`src/lib/websocket-client.ts`)
Entry: `src/lib/websocket-client.ts`
- Client-side WebSocket with auto-reconnect, ping/pong, and fragment reassembly.
- **Key exports:**
  - `WebSocketClient` class - `connect()`, `disconnect()`, `send(type, payload)`, `request(type, payload): Promise`, `on(type, cb)`, `off(type, cb)`

### Model Options (`src/lib/model-options.ts`)
Entry: `src/lib/model-options.ts`
- Provider and model configuration constants.
- **Key exports:**
  - `PROVIDERS` - Provider metadata array (anthropic, openai, google, xai, groq, custom)
  - `PROVIDER_DEFAULT_URLS` - Default API base URLs
  - `MODELS` - Record of provider → model list

### Pages (`src/app/`)
- `page.tsx` - Root redirect to /chat
- `layout.tsx` - Root layout with AppShell, metadata
- `chat/page.tsx` - Chat interface (conversation list + message area + input)
- `agents/page.tsx` - Agent management (tab bar + detail panel + create dialog)
- `settings/page.tsx` - Tabbed settings (Self Agent, Backend Agents, Notifications, General)

### Layout Components (`src/components/layout/`)
- `app-shell.tsx` - Root shell with WebSocketProvider, sidebar, toast
- `sidebar.tsx` - Left nav with running agents list
- `nav-menu.tsx` - Navigation links (Chat, Agents, Settings)
- `top-bar.tsx` - Header bar with logo and sound toggle
- `connection-status.tsx` - WS connection indicator
- `mobile-guard.tsx` - Blocks mobile access
- `toast.tsx` - Toast notification system; `showToast()` global function

### Chat Components (`src/components/chat/`)
- `message-area.tsx` - Message history display with auto-scroll
- `message-bubble.tsx` - Individual message with markdown, tools, attachments
- `input-area.tsx` - Chat input with file upload (drag-drop, 50MB/file, 200MB total, 10 files max)
- `model-selector.tsx` - Provider/model dropdowns + dispatch toggle
- `conversation-list.tsx` - Collapsible conversation sidebar
- `markdown-renderer.tsx` - GFM markdown rendering with syntax highlight
- `tool-timeline.tsx` - Collapsible tool call timeline
- `tool-step.tsx` - Expandable tool call with args/result
- `typing-indicator.tsx` - Three bouncing dots animation
- `file-attachment.tsx` - File card with icon and preview (images/code)
- `attachment-preview.tsx` - Pending upload preview with progress

### Agent Components (`src/components/agents/`)
- `agent-tab-bar.tsx` - Tab bar for switching agents
- `agent-detail-panel.tsx` - Main detail view with terminal or output; `TUI_AGENT_TYPES = ['opencode', 'codex']`
- `agent-output-area.tsx` - Simple output log for non-TUI agents
- `agent-input-box.tsx` - Command input for agents
- `agent-toolbar.tsx` - Create + filter controls
- `agent-tab.tsx` - Single tab with status color indicator
- `agent-info-bar.tsx` - Agent metadata + stop/restart/delete buttons
- `create-agent-dialog.tsx` - Agent creation form dialog
- `ansi-renderer.tsx` - ANSI escape to HTML conversion
- `xterm-terminal.tsx` - xterm.js terminal emulator for TUI agents

### Settings Components (`src/components/settings/`)
- `self-agent-settings.tsx` - Default model, custom model, system prompt
- `credential-editor.tsx` - API key management with test connection
- `backend-agent-settings.tsx` - CLI paths and args for agent types
- `notification-settings.tsx` - Sound and browser notification toggles
- `general-settings.tsx` - Data retention days, import/export

### UI Components (`src/components/ui/`)
- `button.tsx` - Button with variants (default, ghost, outline, destructive) and sizes
- `dialog.tsx` - Radix UI dialog/modal
- `tabs.tsx` - Radix UI tabs
- `switch.tsx` - Radix UI toggle switch
- `input.tsx` - Text input
- `textarea.tsx` - Textarea
- `select.tsx` - Radix UI select dropdown

## Module Dependencies

- `server/index.ts` → `express-app`, `websocket/*`, `db/*`, `services/*` (orchestrates all)
- `server/services/self-agent.ts` → `db/repositories/*`, `services/tools/*`, `services/file-transfer`, `services/agent-process-manager`, `websocket/server` (core AI service)
- `server/services/agent-process-manager.ts` → `services/agent-registry`, `services/output-parsers`, `db/repositories/*`, `websocket/server` (agent lifecycle)
- `server/websocket/chat-handlers.ts` → `services/self-agent` (delegates all chat operations)
- `server/websocket/agent-handlers.ts` → `services/agent-process-manager` (delegates all agent operations)
- `server/express-app.ts` → `services/*`, `db/repositories/*` (REST endpoints)
- `src/hooks/use-websocket.tsx` → `lib/websocket-client`, `stores/*` (dispatches WS events to stores)
- `src/hooks/use-self-agent.ts` → `hooks/use-websocket`, `stores/chat-store` (chat operations)
- `src/hooks/use-agent-manager.ts` → `hooks/use-websocket`, `stores/agent-store` (agent operations)
- `src/stores/*` → standalone Zustand stores, no cross-store dependencies
- `src/components/*` → `stores/*`, `hooks/*`, `lib/*` (UI consumes state and hooks)
- `shared/types.ts` → standalone (imported by both server and client)

## File Index

### server/
| File | Description |
|------|-------------|
| index.ts | Application bootstrap, initialization sequence, graceful shutdown |
| express-app.ts | REST API routes for conversations, settings, credentials, agents, files |

### server/websocket/
| File | Description |
|------|-------------|
| server.ts | WebSocket server init, heartbeat, backpressure, broadcast helpers |
| handler.ts | Central message type → handler dispatch registry |
| protocol.ts | Message serialization and >64KB fragmentation |
| chat-handlers.ts | Handlers for chat.send, chat.abort, chat.steer, chat.switch_model, chat.clear_conversation, chat.set_thinking_level, etc. |
| agent-handlers.ts | Handlers for agent.create, agent.send_input, agent.stop, etc. |

### server/services/
| File | Description |
|------|-------------|
| self-agent.ts | Built-in AI assistant with pi-agent-core, tool execution, streaming |
| agent-process-manager.ts | PTY-based CLI agent spawning, lifecycle, output parsing |
| agent-registry.ts | Pluggable agent type registry (claude-code, opencode, codex) |
| file-transfer.ts | File upload/download with temporary tokens |
| model-detection.ts | Auto-detect models from LLM providers via API |
| credential-store.ts | AES-256-GCM encryption wrapper |
| output-parsers.ts | RingBuffer, ClaudeCodeParser, GenericCLIParser |
| session-manager.ts | WebSocket session tracking |

### server/services/tools/
| File | Description |
|------|-------------|
| builtin-tools.ts | read, write, edit, bash tools for self-agent |
| custom-tools.ts | file_transfer and agent_dispatch tools (created dynamically) |

### server/db/
| File | Description |
|------|-------------|
| index.ts | SQLite + Drizzle ORM initialization, WAL mode, seeding |
| schema.ts | Table definitions for all 7 tables |
| cleanup.ts | Hourly cleanup: expired files, old outputs, VACUUM |

### server/db/repositories/
| File | Description |
|------|-------------|
| index.ts | Barrel export for all repositories |
| conversation-repository.ts | CRUD for conversations with optional archive/pagination |
| message-repository.ts | CRUD for messages, updates conversation timestamps |
| agent-process-repository.ts | CRUD for agent processes with status tracking |
| agent-output-repository.ts | Batch insert/query for agent output logs |
| settings-repository.ts | Key-value settings with prefix queries |
| credential-repository.ts | Encrypted credential CRUD with masking |
| file-transfer-repository.ts | File transfer records with expiration |

### server/utils/
| File | Description |
|------|-------------|
| crypto.ts | AES-256-GCM encrypt/decrypt, key generation |
| logger.ts | Colored console logger with level filtering |

### shared/
| File | Description |
|------|-------------|
| types.ts | All shared types: agents, messages, conversations, WS protocol payloads |

### src/app/
| File | Description |
|------|-------------|
| page.tsx | Root redirect to /chat |
| layout.tsx | Root HTML layout with AppShell and metadata |
| chat/page.tsx | Chat page: conversation list + message area + input |
| agents/page.tsx | Agents page: tab bar + detail panel + create dialog |
| settings/page.tsx | Settings page: tabbed interface (4 tabs) |

### src/stores/
| File | Description |
|------|-------------|
| chat-store.ts | Conversations, messages, streaming, model selection, file attachments |
| agent-store.ts | Agent list, outputs, selected agent, tab order, status filter |
| settings-store.ts | Provider defaults, credentials, detected models, notification prefs |

### src/hooks/
| File | Description |
|------|-------------|
| use-websocket.tsx | WebSocket context provider, event subscription hooks |
| use-agent-manager.ts | Agent CRUD operations hook |
| use-self-agent.ts | Chat messaging and model control hook |
| use-keyboard-shortcuts.ts | Global keyboard shortcuts (Ctrl+1/2/3, Ctrl+N, Ctrl+K, Esc) |

### src/lib/
| File | Description |
|------|-------------|
| types.ts | Re-exports all shared types for frontend convenience |
| websocket-client.ts | WS client with auto-reconnect, ping, fragment reassembly |
| utils.ts | cn() class merge, formatDuration, formatFileSize, formatRelativeTime |
| model-options.ts | Provider configs, default URLs, model lists, custom API modes |
| content-blocks.ts | Groups content blocks (text + tool calls) for message rendering |

### src/components/layout/
| File | Description |
|------|-------------|
| app-shell.tsx | Root shell with WebSocketProvider, sidebar, toast container |
| sidebar.tsx | Collapsible left nav sidebar (icon-only mode) with running agents list |
| nav-menu.tsx | Navigation links with hover tooltips (Chat, Agents, Settings) |
| top-bar.tsx | Header bar with convergence logo and sound toggle |
| connection-status.tsx | WebSocket connection and agent count indicator |
| mobile-guard.tsx | Blocks mobile access with informational message |
| toast.tsx | Toast notification system with global showToast() |

### src/components/chat/
| File | Description |
|------|-------------|
| message-area.tsx | Message history display with auto-scroll |
| message-bubble.tsx | Individual message: markdown, tool calls, attachments |
| input-area.tsx | Chat input with file upload, clear conversation button, thinking level control |
| model-selector.tsx | Provider/model dropdowns + dispatch mode toggle |
| conversation-list.tsx | Collapsible conversation history sidebar |
| markdown-renderer.tsx | GFM markdown with syntax highlighting |
| tool-timeline.tsx | Collapsible tool call timeline |
| tool-step.tsx | Expandable tool call detail (args + result) |
| typing-indicator.tsx | Three bouncing dots animation |
| file-attachment.tsx | File card with icon and type-based preview |
| attachment-preview.tsx | Pending upload preview with progress bar |

### src/components/agents/
| File | Description |
|------|-------------|
| agent-tab-bar.tsx | Tab bar for switching between agents |
| agent-detail-panel.tsx | Agent detail with terminal (TUI) or output area |
| agent-output-area.tsx | Simple scrollable output log for non-TUI agents |
| agent-input-box.tsx | Command input box for sending to agents |
| agent-toolbar.tsx | Create button + status filter controls |
| agent-tab.tsx | Single tab with status color indicator |
| agent-info-bar.tsx | Agent metadata + stop/restart/delete action buttons |
| create-agent-dialog.tsx | Agent creation form with type/name/workdir fields |
| ansi-renderer.tsx | ANSI escape sequences to HTML conversion |
| xterm-terminal.tsx | xterm.js terminal emulator for TUI agents |

### src/components/settings/
| File | Description |
|------|-------------|
| self-agent-settings.tsx | Default model, custom model, system prompt config |
| credential-editor.tsx | API key management with test connection |
| backend-agent-settings.tsx | CLI paths and arguments for agent types |
| notification-settings.tsx | Sound and browser notification toggles |
| general-settings.tsx | Data retention, import/export buttons |

### src/components/ui/
| File | Description |
|------|-------------|
| button.tsx | Button with variants (default, ghost, outline, destructive) |
| dialog.tsx | Radix UI dialog/modal components |
| tabs.tsx | Radix UI tab components |
| switch.tsx | Radix UI toggle switch |
| input.tsx | Styled text input |
| textarea.tsx | Styled textarea |
| select.tsx | Radix UI select dropdown |
